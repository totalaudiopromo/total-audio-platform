{"version":3,"file":"js/xhrInterceptor.js","mappings":"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","sources":["bpm:///GmailXhrInterceptor@1.433/js/treeUtils.js","bpm:///GmailXhrInterceptor@1.433/js/trackerParsingUtils.js","bpm:///GmailXhrInterceptor@1.433/js/xhrInterceptorUtils.js","bpm:///GmailXhrInterceptor@1.433/js/emailParsingUtils.js","bpm:///GmailXhrInterceptor@1.433/js/xhrInterceptor.js","webpack://webpack/bootstrap","webpack://webpack/runtime/define property getters","webpack://webpack/runtime/hasOwnProperty shorthand","webpack://webpack/runtime/make namespace object","bpm:///SignalsExtension@2.32769/js/init/xhr-interceptor.js"],"sourcesContent":["/* hs-eslint ignored failing-rules */\n/* eslint-disable no-prototype-builtins */\n\n'use es6';\n\n// BEFORE ADDING IMPORTS: see project README\n\n// This is a collection of utility methods that get/put data from the tree-like object format\n// used by Gmail in email sync requests. Looking at the related tests is a good way to see some examples\n// of the request bodies we would handle in these methods.\n\n// Deep searches a js object and returns the path to the first node that matches using the matcher function\nexport const treeSearch = (data, matcher) => {\n  for (const key in data) {\n    if (data.hasOwnProperty(key)) {\n      if (matcher(data[key])) {\n        return [key];\n      }\n      const value = data[key];\n      if (typeof value === 'object') {\n        const innerResult = treeSearch(value, matcher);\n        if (innerResult != null) {\n          innerResult.unshift(key);\n          return innerResult;\n        }\n      }\n    }\n  }\n  return null;\n};\n\n// Like immutable getIn\nexport const treeGet = (data, path) =>\n  path.reduce((acc, key) => acc[key], data);\n\n// Like immutable setIn\nexport const treePut = (data, path, value) => {\n  const parentPath = [...path];\n  const lastKey = parentPath.pop();\n  const object = treeGet(data, parentPath);\n  object[lastKey] = value;\n};\n\n// Deep searches a js object and returns the path to the node that shares the most common ancestors\nexport const treeSearchNearestAncestor = (data, path, matcher) => {\n  while (path && path.length >= 0) {\n    const innerResult = treeSearch(treeGet(data, path), matcher);\n    if (innerResult != null) {\n      return path.concat(innerResult);\n    }\n    if (path.length > 0) {\n      path = path.slice(0, path.length - 1);\n    } else {\n      break;\n    }\n  }\n  return null;\n};\n","'use es6';\n\n// BEFORE ADDING IMPORTS: see project README\n\nlet escapeHTMLPolicy = null;\n\nexport const TRACKER_DATA_KEY = 'data-hbstrk';\nexport const ASSOCIATION_DATA_KEY = 'data-hbsasc';\n\nconst unescapeHtml = (escapedStr) => {\n  const div = document.createElement('div');\n\n  if (window.trustedTypes && window.trustedTypes.createPolicy) {\n    if (!escapeHTMLPolicy) {\n      escapeHTMLPolicy = window.trustedTypes.createPolicy(\n        'GmailXhrInterceptor',\n        {\n          createHTML: (to_escape) => to_escape,\n        }\n      );\n    }\n\n    div.innerHTML = escapeHTMLPolicy.createHTML(escapedStr);\n  } else {\n    div.innerHTML = escapedStr;\n  }\n  const child = div.childNodes[0];\n  return child ? child.nodeValue : '';\n};\n\nexport const parseTracker = (emailBody) => {\n  const parsedResult = {\n    trackerData: null,\n    associationData: null,\n    parsedEmailBody: null,\n  };\n\n  const trackerMatch = emailBody.match(\n    new RegExp(`${TRACKER_DATA_KEY}=\"(.*?)\"`)\n  );\n  if (trackerMatch) {\n    const [dataAttr, trackerData] = trackerMatch; // Get the tracker data-attr\n    parsedResult.trackerData = JSON.parse(unescapeHtml(trackerData));\n    emailBody = emailBody.replace(dataAttr, ''); // Remove the data-attr on the pixel\n  }\n\n  const associationMatch = emailBody.match(\n    new RegExp(`<div ${ASSOCIATION_DATA_KEY}=\"(.*?)\"></div>`)\n  );\n  if (associationMatch) {\n    const [dataElement, associationData] = associationMatch; // Get the association data\n    parsedResult.associationData = JSON.parse(unescapeHtml(associationData));\n    emailBody = emailBody.replace(dataElement, ''); // Remove the association data element\n  }\n\n  parsedResult.parsedEmailBody = emailBody;\n\n  return parsedResult;\n};\n","'use es6';\n\n// BEFORE ADDING IMPORTS: see project README\n\nconst postMessage = (data, type) => {\n  document.dispatchEvent(\n    new CustomEvent(type, {\n      detail: {\n        ...data,\n        sender: 'SIG_EXTENSION',\n      },\n    })\n  );\n};\n\n// Since we don't have access to redux state in this script, we pass the data via custom events\n// to be stored in state and saved\nexport const saveTracker = (data) => postMessage(data, 'TRACKER_GENERATED');\n\nexport const saveAssociation = (data) =>\n  postMessage(data, 'ASSOCIATION_GENERATED');\n","'use es6';\n\n// BEFORE ADDING IMPORTS: see project README\n\nimport {\n  treeGet,\n  treeSearchNearestAncestor,\n  treeSearch,\n  treePut,\n} from './treeUtils';\nimport {\n  TRACKER_DATA_KEY,\n  ASSOCIATION_DATA_KEY,\n  parseTracker,\n} from './trackerParsingUtils';\nimport { saveTracker, saveAssociation } from './xhrInterceptorUtils';\n\n/* Example Thread ID Formats:\n  thread-f:1582262280942159186\n  thread-a:r-3439450602660154523\n  thread-a:sa2sa-r-6621052002628866457\n  thread-a:r6621052002628866457\n  thread-f:1570099985108600423|msg-f:1529525089239999438\n*/\nconst jsonThreadIdRegex = /^thread-\\w{1,3}:(\\w{1,6}-?){0,3}\\d{10,25}/;\n\n/* Example Message ID Formats:\n  msg-f:1582262280942159186\n  msg-a:r-3439450602660154523\n  msg-a:r3439450602660154523\n */\nconst jsonMessageIdRegex = /^msg-\\w{1,3}:(\\w{1,6}-?){0,3}\\d{10,25}$/;\n\n// Pattern for gmail sync url\n// Note: _openUrl may be relative, so domain and path may not be in _openUrl depending on how it was called.\nexport const isJsonEmail = (url) => /sync\\/(?:u\\/\\d+\\/)?i\\/s/.test(url);\n\n// regexMatch(regex) -> string node matches regex\nexport const regexMatch = (regex) => (data) => {\n  if (typeof data === 'string' && data.match(regex)) {\n    return true;\n  }\n  return false;\n};\n\n// The Gmail message/thread IDs already exist on send so we extract them from the POST body.\n// The sync request may contain multiple emails, so find the ids closest in the json tree to the body element\nexport const getIdsFromJsonRequest = (jsonData, pathToBody) => {\n  const threadId = treeGet(\n    jsonData,\n    treeSearchNearestAncestor(\n      jsonData,\n      pathToBody,\n      regexMatch(jsonThreadIdRegex)\n    )\n  );\n  const messageId = treeGet(\n    jsonData,\n    treeSearchNearestAncestor(\n      jsonData,\n      pathToBody,\n      regexMatch(jsonMessageIdRegex)\n    )\n  );\n  return { messageId, threadId };\n};\n\n// These POSTSs can represent either send or sync requests:\n// A sync request continuously synchronizes the email to gmail servers (string drafts, etc)\n// A send request is called during the actual email send, and will contain a path to the email body,\n// including the 'data-hbstrk' key. If we find this key, we know it's an actual send.\nexport const parseJsonEmail = (postData) => {\n  const jsonRequestData = JSON.parse(postData);\n  let pathToBody = treeSearch(\n    jsonRequestData,\n    regexMatch(`(${TRACKER_DATA_KEY}|${ASSOCIATION_DATA_KEY})`)\n  );\n  const pathToTracker = treeSearch(\n    jsonRequestData,\n    regexMatch(`(${TRACKER_DATA_KEY})`)\n  );\n  const isSendRequest = !!pathToBody;\n\n  if (isSendRequest) {\n    let emailBody = treeGet(jsonRequestData, pathToBody);\n    let { trackerData, associationData, parsedEmailBody } =\n      parseTracker(emailBody);\n    if (!trackerData && !!pathToTracker) {\n      // This is the path to the tracker in the 'Edit Subject' use case\n      pathToBody = pathToTracker;\n      emailBody = treeGet(jsonRequestData, pathToBody);\n      const parseTrackerResult = parseTracker(emailBody);\n      trackerData = parseTrackerResult.trackerData;\n      parsedEmailBody = parseTrackerResult.parsedEmailBody;\n      associationData = parseTrackerResult.associationData;\n    }\n\n    if (trackerData || associationData) {\n      treePut(jsonRequestData, pathToBody, parsedEmailBody);\n      const { threadId, messageId } = getIdsFromJsonRequest(\n        jsonRequestData,\n        pathToBody\n      );\n\n      if (trackerData) {\n        if (trackerData.tracker && trackerData.tracker.email) {\n          trackerData.tracker.email.gmail_ui_id = messageId;\n          trackerData.tracker.email.gmail_ui_thread_id = threadId;\n          saveTracker(trackerData);\n        } else {\n          console.error(\n            'Error during email parsing: tracker was not build properly'\n          );\n        }\n      }\n      if (associationData) {\n        const { association } = associationData;\n        if (association) {\n          association.gmail_ui_id = messageId;\n          association.gmail_ui_thread_id = threadId;\n          saveAssociation(association);\n        } else {\n          console.error(\n            'Error during email parsing: association was not build properly'\n          );\n        }\n      }\n    }\n  }\n};\n","'use es6';\n\n// BEFORE ADDING IMPORTS: see project README\nimport { isJsonEmail, parseJsonEmail } from './emailParsingUtils';\n\nexport const interceptSend = (request, postData) => {\n  const openUrl = request._openUrl;\n  if (isJsonEmail(openUrl)) {\n    parseJsonEmail(postData);\n  }\n};\n\nconst originalOpen = window.XMLHttpRequest.prototype.open;\nwindow.XMLHttpRequest.prototype.open = function open(method, url) {\n  this._openUrl = url;\n  originalOpen.apply(this, arguments); // eslint-disable-line prefer-rest-params\n};\n\n// No arrow methods - we need a function definition because we use 'this'\nconst origSend = window.XMLHttpRequest.prototype.send;\nwindow.XMLHttpRequest.prototype.send = function send(postData) {\n  // We wrap this in a try, so if we encounter any errors, we don't block the xhr\n  try {\n    interceptSend(this, postData);\n  } catch (e) {\n    console.error(e);\n  }\n  origSend.apply(this, arguments); // eslint-disable-line prefer-rest-params\n};\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = function(exports, definition) {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = function(obj, prop) { return Object.prototype.hasOwnProperty.call(obj, prop); }","// define __esModule on exports\n__webpack_require__.r = function(exports) {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","'use es6';\n\n// Making sure we don't miss error in loading xhrInterceptor\ntry {\n  require('GmailXhrInterceptor/xhrInterceptor');\n} catch (err) {\n  const errorStr = `xhrInterceptor failed to load: ${err.message || err}`;\n  console.error(\n    `%c${errorStr}`,\n    'font-size: x-large; padding: 5px; background: red; color: yellow; '\n  );\n\n  // Dispatch event to alert the extension\n  // chrome.runtime.sendMessage does not work between global script and the extension\n  document.dispatchEvent(\n    new CustomEvent('xhr_interceptor', {\n      detail: {\n        type: 'LOAD_ERROR',\n        message: errorStr,\n        stacktrace: err.stack,\n      },\n    })\n  );\n}\n"],"names":["treeSearch","data","matcher","key","hasOwnProperty","value","innerResult","unshift","treeGet","path","reduce","acc","treePut","parentPath","lastKey","pop","treeSearchNearestAncestor","length","concat","slice","escapeHTMLPolicy","TRACKER_DATA_KEY","ASSOCIATION_DATA_KEY","unescapeHtml","escapedStr","div","document","createElement","window","trustedTypes","createPolicy","createHTML","to_escape","innerHTML","child","childNodes","nodeValue","parseTracker","emailBody","parsedResult","trackerData","associationData","parsedEmailBody","trackerMatch","match","RegExp","dataAttr","JSON","parse","replace","associationMatch","dataElement","postMessage","type","dispatchEvent","CustomEvent","detail","Object","assign","sender","saveTracker","saveAssociation","jsonThreadIdRegex","jsonMessageIdRegex","isJsonEmail","url","test","regexMatch","regex","getIdsFromJsonRequest","jsonData","pathToBody","threadId","messageId","parseJsonEmail","postData","jsonRequestData","pathToTracker","parseTrackerResult","tracker","email","gmail_ui_id","gmail_ui_thread_id","console","error","association","interceptSend","request","openUrl","_openUrl","originalOpen","XMLHttpRequest","prototype","open","method","this","apply","arguments","origSend","send","e","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","exports","module","__webpack_modules__","d","definition","o","defineProperty","enumerable","get","obj","prop","call","r","Symbol","toStringTag","require","err","errorStr","message","stacktrace","stack"],"sourceRoot":""}